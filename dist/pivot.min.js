(function(t){function e(t,e){var i,o=u.createElement(t);for(i in e)"class"===i?o.className=e[i]:o.setAttribute(i,e[i]);return o}function i(t,e,i,o){t.addEventListener(i,function(i){for(var n=i.target,s=d.util.slice.call(t.querySelectorAll(e));n&&0>s.indexOf(n);)n=n.parentNode;n&&n!==t&&n!==u&&o.call(n,i)},!1)}function o(t,e){for(;t!==u&&!d.util.matchesSelector(t,e);)t=t.parentNode;return t}function n(t){var e,i=d.util.slice.call(arguments),o=0;return"object"==typeof i[1]?t.replace(/\{(\w+)\}/g,function(){return void 0!==i[1][arguments[1]]?i[1][arguments[1]]:arguments[0]}):t.replace(/\{(\w*)\}/g,function(){return e=i[++o],void 0!==e?e:arguments[0]})}function s(t,e){var i=new XMLHttpRequest;i.addEventListener("readystatechange",function(){4===i.readyState&&200===i.status&&e(JSON.parse(i.responseText))},!1),i.open("GET",t,!0),i.send()}function a(t,e){var i;return e=e||t.target,i=e.getBoundingClientRect(),{x:Math.max(0,Math.min(1,(t.clientX-i.left)/i.width)),y:Math.max(0,Math.min(1,(t.clientY-i.top)/i.height)),box:i}}function r(t,e){return(t%e+e)%e}function h(t,e,i){this.element=t,this.setType(e),this.element.addEventListener(e,i,!1),this.onTouchEnd=this.onTouchEnd.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.element.addEventListener("touchstart",this.onTouchStart,!1)}function l(t,e,i){return new h(t,e,i)}function c(t){var e=function(t){t.preventDefault()};t.addEventListener("touchmove",e,!1)}var d=t.pivot||(t.pivot={}),u=t.document,p=Element.prototype,m=Function.prototype;d.util={},d.util.slice=[].slice,Modernizr.addTest("devicemotion",function(){return void 0!==t.ondevicemotion}),Modernizr.addTest("matchesselector",function(){var t=["webkit","moz","ms","o"].reduce(function(t,e){return t||p[e+"MatchesSelector"]},p.matchesSelector);return!!(d.util.matchesSelector=t&&m.call.bind(t))}),h.availableEvents=["swipeleft","swiperight"],h.prototype={setType:function(t){this.type=t.toLowerCase(),this.event=u.createEvent("Events"),this.event.initEvent(t,!0,!1)},dispatchEvent:function(t,e){this.type===e.toLowerCase()&&t.dispatchEvent(this.event)},getCoords:function(t){return{x:t.touches[0].pageX,y:t.touches[0].pageY}},onTouchStart:function(t){(this.startCoords=this.getCoords(t))&&(this.element.addEventListener("touchend",this.onTouchEnd,!1),this.element.addEventListener("touchmove",this.onTouchMove,!1))},onTouchMove:function(t){this.moveCoords=this.getCoords(t)},onTouchEnd:function(t){var e;this.element.removeEventListener("touchend",this.onTouchEnd,!1),this.element.removeEventListener("touchmove",this.onTouchMove,!1),this.moveCoords&&(e={x:this.startCoords.x-this.moveCoords.x,y:this.startCoords.y-this.moveCoords.y},(Math.abs(e.x)>30||Math.abs(e.y)>30)&&this.dispatchEvent(t.target,e.x>0?"swipeleft":"swiperight"),delete this.moveCoords)}},d.util.makeElement=e,d.util.delegate=i,d.util.ancestor=o,d.util.supplant=n,d.util.getJSON=s,d.util.localCoordinates=a,d.util.mod=r,d.util.gesturize=l,d.util.preventTouchScroll=c,Object.prototype.__defineGetter__&&!Object.defineProperty&&(Object.defineProperty=function(t,e,i){"get"in i&&t.__defineGetter__(e,i.get),"set"in i&&t.__defineSetter__(e,i.set)}),null==typeof Element||Element.hasOwnProperty.call(Element.prototype,"classList")||function(){var t=function(t){return new RegExp("(^|\\s)"+t+"(\\s|$)")},e=function(t){this.element=t},i=function(){return new e(this)};e.prototype={contains:function(e){return t(e).test(this.element.className)},add:function(t){this.contains(t)||(this.element.className+=(this.element.className?" ":"")+t)},remove:function(e){this.element.className=this.element.className.replace(t(e)," ").trim()},toggle:function(e){var i=t(e);i.test(this.element.className)?this.element.className=this.element.className.replace(i," ").trim():this.element.className+=(this.element.className?" ":"")+e}},Object.defineProperty(Element.prototype,"classList",{get:i})}()})(this),function(t){var e=t.pivot||(t.pivot={}),i=t.document,o=e.util.supplant,n=Modernizr.prefixed("Transform");e.Gallery=function(n){var s;this.wrapper=n.wrapper||i.body,this.quality=n.quality||"medium",this.page=1,this.perPage=this.rows*this.columns,s={perPage:this.rows*this.columns},n.jsonName?(this.feed=e.flickr.feeds.jsonFeed,s.jsonName=n.jsonName):n.groupId?(this.feed=e.flickr.feeds.group,s.groupId=n.groupId):this.feed=e.flickr.feeds.interesting,this.feed=o(this.feed,s),this.photoLoadCount=0,this.aspectRatio=1.78,this.photos=[],this.rows=2,this.columns=3,this.allowedRotation=n.allowedRotation||t.orientation?120:90,this.tiltLag=7,this.rotationDelta={x:0,y:0},this.movementCoordinates={x:0,y:0},this.currentRotation={x:0,y:0},this.onFlickrResult=this.onFlickrResult.bind(this),this.getNextFlickrPage=this.getNextFlickrPage.bind(this),this.constrainLayout=this.constrainLayout.bind(this),this.tilt=this.tilt.bind(this),this.container=e.util.makeElement("div",{"class":"pivot"}),n.wrapper||this.container.classList.add("fullscreen"),this.wrapper.appendChild(this.container),this.viewport=e.util.makeElement("div",{"class":"p-viewport"}),this.zoomPlane=e.util.makeElement("div",{"class":"p-zoom-plane"}),this.viewport.appendChild(this.zoomPlane),this.tiltPlane=e.util.makeElement("div",{"class":"p-tilt-plane"}),this.zoomPlane.appendChild(this.tiltPlane),this.trackingPlane=e.util.makeElement("div",{"class":"p-tracking-plane"}),this.tiltPlane.appendChild(this.trackingPlane),this.getFlickrPage=this.getFlickrPage.bind(this),setTimeout(this.getFlickrPage,400),this.controls=e.util.makeElement("div",{"class":"p-controls"}),this.refresh=e.util.makeElement("button",{"class":"p-refresh"}),this.controls.appendChild(this.refresh),this.galleryControls=e.util.makeElement("div",{"class":"p-galleryControls"}),this.backButton=e.util.makeElement("button",{"class":"p-backButton"}),this.galleryControls.appendChild(this.backButton),this.viewport.appendChild(this.galleryControls),this.backButton.currentProjectParent=n.currentProjectParent||"",console.error(this.backButton.currentProjectParent),this.constrainLayout(),this.container.appendChild(this.viewport),this.container.appendChild(this.controls),t.addEventListener("resize",this.constrainLayout,!1),this.trackingPlane.addEventListener("load",this.onPhotoLoaded.bind(this),!1),this.trackingPlane.addEventListener("nodeLoad",this.onSelectedClickDelegate.bind(this),!1),i.addEventListener("keydown",this.onKeyDown.bind(this),!1),e.util.delegate(this.viewport,".p-photo","click",this.onPhotoClickDelegate.bind(this)),this.refresh.addEventListener("click",this.onCloseButton,!1),this.backButton.addEventListener("click",this.onBackButton,!1),this.zoomOut=this.zoomOut.bind(this),this.container.addEventListener("click",this.zoomOut,!1),Modernizr.devicemotion&&Modernizr.touch?(t.addEventListener("devicemotion",this.onDeviceMotion.bind(this),!1),t.addEventListener("orientationchange",this.constrainLayout,!1)):this.container.addEventListener("mousemove",this.onContainerMouseMove.bind(this),!1),Modernizr.touch&&(e.util.preventTouchScroll(i.body),e.util.gesturize(this.viewport,"swipeleft",this.cycle.bind(this,"next"),!0,!1),e.util.gesturize(this.viewport,"swiperight",this.cycle.bind(this,"prev"),!0,!1)),this.zoomOut(),this.setSelectedPhoto(this.getPhoto(0,0))},e.Gallery.prototype={constrainLayout:function(){var t=this.container.clientWidth,e=this.container.clientHeight;Math.min(t,e),this.zoomPlane.style.width=e*this.aspectRatio+"px",this.zoomPlane.style.height=e+"px",t>e?(this.zoomPlane.style.left=(t-e*this.aspectRatio)/2+"px",this.zoomPlane.style.top=0):(this.zoomPlane.style.top=(e-t)/2+"px",this.zoomPlane.style.left=0)},getPhotoGrid:function(t){t.photos.photo.length<this.columns&&(this.columns=t.photos.photo.length),this.rows=Math.ceil(t.photos.photo.length/this.columns),this.zoomOut();for(var i=0;t.photos.photo.length>i;i++)this.photos.push(new e.Photo({container:this.trackingPlane,row:this.getRow(i),column:this.getColumn(i,row),rows:this.rows,quality:this.quality,id:"imageItem"+i}))},getRow:function(t){return row=Math.floor(t/this.columns)},getColumn:function(t,e){return column=t>this.columns-1?t-this.columns*e:t},getPhoto:function(t,e){var i=o('.p-photo[data-row="{row}"][data-column="{column}"]',t,e);return this.container.querySelector(i)},getSelectedPhoto:function(){return this.container.querySelector(".p-photo.selected")},setSelectedPhoto:function(t){var e=this.getSelectedPhoto();return e&&(e.classList.remove("selected"),e.classList.remove("flipped")),t.classList.add("selected"),this.track(),t},sendFlickrRequest:function(t){this.photoLoadCount=0,this.container.classList.add("gallery-loading"),e.util.getJSON(t,this.onFlickrResult)},onFlickrResult:function(t){this.getPhotoGrid(t),t.photos.photo.forEach(function(t,e){this.photos[e].insertFlickrData(t)},this),this.photoLoadCount+=this.photos.length-t.photos.photo.length,this.photos.slice(t.photos.photo.length).forEach(function(t){t.setSource("")})},getFlickrPage:function(t){this.page=t>0?t:1,this.sendFlickrRequest(o(this.feed,{page:this.page}))},getNextFlickrPage:function(){this.getFlickrPage(this.page+1)},cycle:function(t){var i=this.getSelectedPhoto(),o=i?parseInt(i.getAttribute("data-row"),10):0,n=i?parseInt(i.getAttribute("data-column"),10):0;switch(t){case"left":n=e.util.mod(n-1,this.columns);break;case"right":n=(n+1)%this.columns;break;case"up":o=e.util.mod(o-1,this.rows);break;case"down":o=(o+1)%this.rows;break;case"next":this.columns-1>n?n++:(n=0,o=this.rows-1>o?o+1:0);break;case"prev":n?n--:(n=this.columns-1,o=o?o-1:this.rows-1)}this.setSelectedPhoto(this.getPhoto(o,n))},zoomIn:function(){this.container.classList.add("zoomed"),this.zoomed=!0,this.zoomPlane.style[n]="translate3d(0, 0, 0)",this.track(),this.tilting||this.tilt()},zoomOut:function(){this.container.classList.remove("zoomed"),this.zoomed=!1,this.zoomPlane.style[n]=o("translate3d(0, 0, {z}px)",{z:800*-this.rows}),this.track()},track:function(){var t,e;this.zoomed?(t=this.getSelectedPhoto(),e=o("translate3d({x}%, {y}%, -150px)",{x:-100*t.getAttribute("data-column"),y:-100*t.getAttribute("data-row")})):e=o("translate3d({x}%, {y}%, 1px)",{x:-100*(this.columns/2)+50,y:-100*(this.rows/2)+50}),this.trackingPlane.style[n]=e},tilt:function(){var e=this.zoomed&&void 0===t.orientation?this.allowedRotation/4:this.allowedRotation;this.tilting=!0,this.rotationDelta.x=(e*(this.movementCoordinates.y-.5)-this.currentRotation.x)/this.tiltLag,this.rotationDelta.y=(e*(this.movementCoordinates.x-.5)+this.currentRotation.y)/this.tiltLag,this.currentRotation.x+=this.rotationDelta.x,this.currentRotation.y-=this.rotationDelta.y,this.tiltPlane.style[n]=o("rotateX({x}deg) rotateY({y}deg)",this.currentRotation.x,this.currentRotation.y),Math.abs(this.rotationDelta.x)+Math.abs(this.rotationDelta.y)>.05?setTimeout(this.tilt,1e3/30):this.tilting=!1},onPhotoLoaded:function(){this.photoLoadCount++,this.photoLoadCount===this.photos.length&&this.container.classList.remove("gallery-loading")},onPhotoClickDelegate:function(t){var i=e.util.ancestor(t.target,".p-photo");t.target!==i&&t.stopPropagation(),this.setSelectedPhoto(i),this.zoomed||this.zoomIn()},onSelectedClickDelegate:function(t){this.zoomed&&this.zoomOut(),e.setup({quality:"medium",jsonName:t.target.childProject,currentProjectParent:this.feed})},getCurrentFileName:function(t){return this.path=t,this.p_filename=this.path.substr(this.path.lastIndexOf("/")+1),this.p_filename=this.p_filename.substring(0,this.p_filename.lastIndexOf(".")),this.p_filename},onBackButton:function(t){this.path=e.Gallery.prototype.getCurrentFileName(t.target.currentProjectParent),this.path&&e.setup({quality:"medium",jsonName:this.path})},onCloseButton:function(t){this.container=e.util.ancestor(t.target,".pivot"),this.container.classList.add("gallery-fadeOut")},onViewportMouseWheel:function(t){if(t.wheelDelta||0>t.detail)this.zoomOut();else{var i=e.util.ancestor(t.target,".p-photo");t.target!==i?t.stopPropagation():this.onPhotoClickDelegate(t)}},onKeyDown:function(t){switch(t.keyCode){case 37:this.cycle("left");break;case 39:this.cycle("right");break;case 38:this.cycle("up");break;case 40:this.cycle("down");break;case 13:this.getSelectedPhoto().classList.toggle("flipped");break;case 82:this.getNextFlickrPage();break;case 32:this.zoomed?this.zoomOut():this.zoomIn()}},onContainerMouseMove:function(t){this.movementCoordinates=e.util.localCoordinates(t,this.container),this.tilting||this.tilt()},onDeviceMotion:function(e){var i,o=0===t.orientation%180,n=o?"x":"y",s=o?"y":"x";i={x:180===t.orientation||90===t.orientation?-1:1,y:0===t.orientation||90===t.orientation?-1:1},this.movementCoordinates.x=(i[n]*e.accelerationIncludingGravity[n]+10)/20,this.movementCoordinates.y=(i[s]*e.accelerationIncludingGravity[s]+10)/20,this.tilting||this.tilt()},onOrientationChange:function(){this.constrainLayout()}},e.setup=function(t){return Modernizr&&Modernizr.matchesselector&&Modernizr.csstransforms3d?(0!=$(".pivot").length&&$(".pivot").remove(),new e.Gallery(t)):void 0}}(this),function(t){var e=t.pivot||(t.pivot={}),i=t.document,o=e.util.supplant,n=Modernizr.prefixed("Transform");e.Photo=function(t){this.row=t.row,this.column=t.column,this.rows=t.rows,this.id=t.id,this.quality=t.quality,this.aspectRatio=1,this.loadEvent=i.createEvent("Events"),this.loadEvent.initEvent("load",!0,!1),this.nodeLoadEvent=i.createEvent("Events"),this.nodeLoadEvent.initEvent("nodeLoad",!0,!1),this.container=e.util.makeElement("itemCard",{"class":"p-photo loading no-img","data-row":this.row,"data-column":this.column}),this.container.style[n]=o("translate3d({x}%, {y}%, 1px)",{x:100*this.column,y:100*this.row}),this.backing=e.util.makeElement("div",{"class":"p-backing"}),this.backing.style[n]=o("translate3d({x}px, {y}px, {z}px) rotate({r}deg)",{x:2e3*Math.random()-1e3,y:2e3*Math.random()-1e3,z:-16e3*Math.random(),r:-16e3*Math.random()}),this.backing.style.opacity=0,this.container.appendChild(this.backing),this.imageWrapper=e.util.makeElement("div",{"class":"p-image-wrapper"}),this.container.appendChild(this.imageWrapper),this.caption=e.util.makeElement("figcaption"),this.imageWrapper.appendChild(this.caption),this.image=e.util.makeElement("img",{draggable:!1}),this.imageWrapper.appendChild(this.image),this.imagePreloader=new Image,t.container.appendChild(this.container),this.completeLoading=this.completeLoading.bind(this),this.imagePreloader.addEventListener("load",this.onImagePreloaderLoad.bind(this),!1),this.imagePreloader.addEventListener("error",this.onImagePreloaderError.bind(this),!1),this.imageWrapper.addEventListener("click",this.onImageWrapperClick.bind(this),!1),this.backing.addEventListener("webkitAnimationEnd",this.onBackingAnimationEnd=this.onBackingAnimationEnd.bind(this),!1),this.backing.addEventListener("animationend",this.onBackingAnimationEnd,!1),setTimeout(this.resetBackingTransform.bind(this),0)},e.Photo.prototype={setSource:function(t){this.image.src!==t?(this.container.classList.add("loading"),this.container.classList.remove("flipped"),this.imagePreloader.src=t):this.onImagePreloaderError()},setCaption:function(t){this.caption.innerHTML=t},insertFlickrData:function(t){photoProperties=t,t.pageURL=o(e.flickr.pageURL,t),this.container.setAttribute("id",this.id),this.container.objectType=t.objectType,this.container.childProject=t.childProject,t.title=t.title||"Untitled",this.setCaption(o(e.flickr.captionTemplate,t)),this.setSource(o(e.flickr.sourceURLs[this.quality],t))},resetBackingTransform:function(){this.backing.style.cssText=""},completeLoading:function(){this.image.src=this.imagePreloader.src;var t=this.image.naturalWidth/this.image.naturalHeight;this.wrapperDimensions=1>t?o("top: {top}%; left: 5%; width: 90%; height: {height}%;",{top:5,height:90}):o("top: 5%; left: {left}%; width: {width}%; height: 90%;",{left:5,width:90}),this.imageWrapper.style.cssText=this.wrapperDimensions,this.container.classList.remove("loading"),this.container.classList.remove("no-img"),this.container.classList.add("done-loading"),this.container.dispatchEvent(this.loadEvent)},onBackingAnimationEnd:function(){this.backing.style.cssText=this.wrapperDimensions,this.container.classList.remove("done-loading")},onImagePreloaderLoad:function(){setTimeout(this.completeLoading,250*(this.column+this.row*this.rows))},onImagePreloaderError:function(){this.container.classList.add("no-img"),this.container.dispatchEvent(this.loadEvent)},onImageWrapperClick:function(t){if(e.util.matchesSelector(this.container,".pivot.zoomed .p-photo.selected")){t.stopPropagation();var i=t.target.parentNode;i=i.parentNode,"nodeCard"!==i.objectType?this.container.classList.toggle("flipped"):this.container.dispatchEvent(this.nodeLoadEvent)}}}}(this),function(t){var e=t.pivot||(t.pivot={});e.flickr={captionTemplate:'<h1><a href="{pageURL}" target="blank" tabindex="-1">{title}</a></h1><p>{description}</p>',sourceURLs:{high:"http://farm{farm}.static.flickr.com/{server}/{id}_{secret}_b.jpg",medium:"http://dlduckworth.com/{imagePath}/{category}/{project}/{imageName_lg}",low:"http://farm{farm}.static.flickr.com/{server}/{id}_{secret}_m.jpg"},pageURL:"http://dlduckworth.com/{imagePath}/{category}/{project}/{imageName_lg}",feeds:{jsonFeed:"../json/{jsonName}.json",group:"http://api.flickr.com/services/rest/?method=flickr.groups.pools.getPhotos&api_key=6fff138dbd0fbe330c07a67c47c9cc21&group_id={groupId}&per_page={perPage}&page={page}&extras=description,owner_name&format=json&nojsoncallback=1",interesting:"../json/interface_mixprototype.json"}}}(this);
